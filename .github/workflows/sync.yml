name: Upstream Sync

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  sync_latest_from_upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Sync Upstream
        uses: actions/github-script@v6
        with:
          script: |
            const core = require('@actions/core');
            const exec = require('@actions/exec');

            try {
              // Configure Git
              await exec.exec('git', ['config', '--global', 'user.name', 'GitHub Actions']);
              await exec.exec('git', ['config', '--global', 'user.email', 'actions@github.com']);

              // Add Upstream
              await exec.exec('git', ['remote', 'add', 'upstream', 'https://github.com/chatgptuk/ldc-shop.git']);
              await exec.exec('git', ['fetch', 'upstream']);

              // Hard Reset to Upstream Main
              // using Reset instead of Merge avoids "unrelated histories" and conflicts
              await exec.exec('git', ['checkout', 'main']);
              await exec.exec('git', ['reset', '--hard', 'upstream/main']);

              // Force Push
              // Note: using GITHUB_TOKEN directly via git auth header if possible, or reliance on actions/checkout setup
              await exec.exec('git', ['push', 'origin', 'main', '--force']);
              
            } catch (error) {
              core.setFailed(`Sync failed: ${error.message}`);
            }
